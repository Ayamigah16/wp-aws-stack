#!/bin/bash
###############################################################################
# WordPress Backup Script
# Automated database and files backup with rotation
###############################################################################

set -euo pipefail

BACKUP_DIR="{{ backup_dir }}"
WP_DIR="{{ wp_dir }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS="{{ backup_retention_days }}"

# Source database credentials
source {{ secrets_file }}

# Create backup directory
mkdir -p "$BACKUP_DIR"

echo "Starting backup at $(date)"

# Backup database
echo "Backing up database: $WP_DB_NAME"
mysqldump -u "$WP_DB_USER" -p"$WP_DB_PASSWORD" "$WP_DB_NAME" | gzip > "$BACKUP_DIR/db_$TIMESTAMP.sql.gz"

if [ $? -eq 0 ]; then
    echo "Database backup completed: db_$TIMESTAMP.sql.gz"
else
    echo "ERROR: Database backup failed!"
    exit 1
fi

# Backup WordPress files
echo "Backing up WordPress files from $WP_DIR"
tar -czf "$BACKUP_DIR/files_$TIMESTAMP.tar.gz" -C "$(dirname $WP_DIR)" "$(basename $WP_DIR)" 2>/dev/null

if [ $? -eq 0 ]; then
    echo "Files backup completed: files_$TIMESTAMP.tar.gz"
else
    echo "ERROR: Files backup failed!"
    exit 1
fi

# Remove old backups
echo "Removing backups older than $RETENTION_DAYS days"
find "$BACKUP_DIR" -name "db_*.sql.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "files_*.tar.gz" -mtime +$RETENTION_DAYS -delete

# Calculate backup sizes
DB_SIZE=$(du -h "$BACKUP_DIR/db_$TIMESTAMP.sql.gz" | cut -f1)
FILES_SIZE=$(du -h "$BACKUP_DIR/files_$TIMESTAMP.tar.gz" | cut -f1)

echo "Backup completed successfully at $(date)"
echo "Database backup size: $DB_SIZE"
echo "Files backup size: $FILES_SIZE"

# Optional: Upload to S3
# Uncomment and configure if using S3 for offsite backups
# aws s3 cp "$BACKUP_DIR/db_$TIMESTAMP.sql.gz" "s3://{{ s3_backup_bucket | default('your-bucket') }}/wordpress/db/"
# aws s3 cp "$BACKUP_DIR/files_$TIMESTAMP.tar.gz" "s3://{{ s3_backup_bucket | default('your-bucket') }}/wordpress/files/"

# Log summary
cat >> /var/log/wordpress-backup.log <<LOG
$(date): Backup completed
  - Database: db_$TIMESTAMP.sql.gz ($DB_SIZE)
  - Files: files_$TIMESTAMP.tar.gz ($FILES_SIZE)
  - Retention: $RETENTION_DAYS days
LOG

exit 0
